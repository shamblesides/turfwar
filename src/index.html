<!DOCTYPE html>
<title>IPv4 Turf War</title>
<meta charset="utf8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
    body {
        margin: 0;
        padding: 0.5em;
    }
    #segments {
        font-family: monospace;
        width: 162em;
        line-height: 1.2;
        text-align: right;
    }
    .segment {
        width: 10em;
        display: inline-block;
        padding: 4px;
        box-sizing: border-box;
        vertical-align: middle;
    }
    .segment-loading {
        font-style: italic;
        opacity: 0.7;
    }
    .segment-empty {
        opacity: 0.5;
    }
    .segment-tied {
        background-color: #f4f4f4;
    }
    .segment > * {
        display: block;
    }
</style>

<h1>Claim The Land At <span id="my-ip">Your IP</span></h1>
<form action="/claim" method="GET">
    <label for="name">I claim this land for</label>
    <input type="text" minlength="8" maxlength="8" pattern="[a-zA-Z0-9]+" name="name" placeholder="namehere" onchange="onNameFieldChange(this)">
    <button type="submit">Claim!</button>
</form>
<p><a href="/about.html" target="_blank">(What is this?)</a></p>

<h1>Top Players</h1>
<ol id="top-players">
    <li>Loading top players...</li>
</ol>

<h1>All /8 Address Blocks</h1>
<noscript>(Requires JavaScript to view)</noscript>
<div id="segments"></div>
<template id="segment">
    <div class="segment segment-loading">
        <span class="segment-cidr">Loading...</span
        ><span class="segment-nick"></span><span class="segment-count"></span>
    </div>
</template>

<script>
    function onNameFieldChange(el) {
        if (el.validity.tooShort || el.validity.tooLong) {
            el.setCustomValidity('Name should be EXACTLY 8 characters.')
            el.reportValidity();
        } else if (el.validity.patternMismatch) {
            el.setCustomValidity('Name should be ASCII alphanumeric.')
            el.reportValidity();
        } else {
            el.setCustomValidity('')
        }
    }

    function hilbertRotate(point, rx, ry, n) {
        if (ry !== 0) {
            return;
        }
        if (rx === 1) {
            point.x = n - 1 - point.x;
            point.y = n - 1 - point.y;
        }
        [point.x, point.y] = [point.y, point.x];
    }

    function hilbertPointToIndex(point, order) {
        const n = 2 ** order;
        let rx,
            ry,
            index = 0;
        for (let s = n / 2; s > 0; s = Math.floor(s / 2)) {
            rx = (point.x & s) > 0 ? 1 : 0;
            ry = (point.y & s) > 0 ? 1 : 0;
            index += s * s * ((3 * rx) ^ ry);
            hilbertRotate(point, rx, ry, n);
        }
        return index;
    }

    function cyrb53 (str, seed = 0) {
        let h1 = 0xdeadbeef ^ seed, h2 = 0x41c6ce57 ^ seed;
        for (let i = 0, ch; i < str.length; i++) {
            ch = str.charCodeAt(i);
            h1 = Math.imul(h1 ^ ch, 2654435761);
            h2 = Math.imul(h2 ^ ch, 1597334677);
        }
        h1 = Math.imul(h1 ^ (h1>>>16), 2246822507) ^ Math.imul(h2 ^ (h2>>>13), 3266489909);
        h2 = Math.imul(h2 ^ (h2>>>16), 2246822507) ^ Math.imul(h1 ^ (h1>>>13), 3266489909);
        return 4294967296 * (2097151 & h2) + (h1>>>0);
    }

    function blockColor(str) {
        const hash = cyrb53(str);
        const hue = (hash & 0xFFF) / 0xFFF * 360 | 0;
        const backgroundColor = `hsla(${hue}, 100%, 85%, 1)`;
        return backgroundColor;
    }

    fetch('/ip').then(res => res.status === 200 ? res.text() : null).then(myIP => {
        if (myIP != null) {
            document.getElementById('my-ip').innerText = myIP;
        }
    }).then(() => {
        /** @type{HTMLTemplateElement} */
        const segmentTemplate = document.querySelector('#segment');
        const segmentsSection = document.querySelector('#segments')

        const hilbertCurve = Array(16).fill().flatMap((_,y) =>
            Array(16).fill().map((_,x) =>
                hilbertPointToIndex({x, y}, 8)
        ));
        const champs = hilbertCurve.map((i,_) => {
            /** @type{HTMLElement} */
            const el = segmentTemplate.content.cloneNode(true).querySelector('*');
            segmentsSection.appendChild(el);

            const cidr = `${i}.0.0.0/8`;
            return fetch(`/summary?subnet=${cidr}`).then(res => res.json()).then(json => {
                el.classList.remove('segment-loading');
                el.querySelector('.segment-cidr').innerText = cidr;

                const list = Object.entries(json).sort(([k1,v1],[k2,v2]) => v2-v1);
                if (list.length > 0) {
                    const [name, count] = list[0];
                    el.querySelector('.segment-count').innerText = `(${count} IP${count == 1 ? '' : 's'})`;
                    if (list.length > 1 && list[1][1] === count) {
                        el.querySelector('.segment-nick').innerText = '(tied)';
                        el.classList.add('segment-tied');
                        return null;
                    } else {
                        el.querySelector('.segment-nick').innerText = name;
                        el.classList.add('segment-ready');
                        el.style.backgroundColor = blockColor(name)
                        return name;
                    }
                } else {
                    el.classList.add('segment-empty');
                    return null;
                }
            })
        });

        Promise.all(champs).then(champs => {
            const ol = document.getElementById('top-players');
            ol.innerHTML = '';

            const ranking = {};
            champs.forEach((name, i) => {
                if (name != null) {
                    ranking[name] = (ranking[name] || []).concat([i]);
                }
            });
            let winners = Object.entries(ranking).sort(([k1,v1], [k2,v2]) => v2.length-v1.length);
            while (winners.length > 10) {
                const worst = winners.pop()[1].length;
                winners = winners.filter(([name, blocksOwned]) => blocksOwned.length > worst);
            }
            for (const [name, blocksOwned] of winners) {
                const li = document.createElement('li');
                li.innerText =  `${name} with ${blocksOwned.length} blocks ... ${blocksOwned.join(', ')}`
                ol.appendChild(li);
            }
        });
    })
</script>
